machine:
  timezone:
    America/New_York
  node:
    version: v0.11.13
  php:
    version: 5.6.2
  services:
    - docker
    - memcached
    # - mysql
    # - elasticsearch

  hosts:
    edm.wpcloud.io: 127.0.0.1
    2014.dayafter.com: 127.0.0.1
    hififest.com: 127.0.0.1
    2013.monsterblockparty.com: 127.0.0.1
    2013.freaksbeatstreats.com: 127.0.0.1
    winterfantasyrgv-com.discodonniepresents.com: 127.0.0.1
    gifttampa-com.discodonniepresents.com: 127.0.0.1
    bassodyssey-com.discodonniepresents.com: 127.0.0.1
    discodonniepresents.com: 127.0.0.1
    mexico.lightsallnight.com: 127.0.0.1
    umesouthpadre.com: 127.0.0.1
    smftampa.com: 127.0.0.1
    sugarsociety.com: 127.0.0.1
    gxgmag.com: 127.0.0.1
    hireheadline.com: 127.0.0.1
    suncitymusicfestival.com: 127.0.0.1
    wildwood.beachblanketfestival.com: 127.0.0.1
    galveston.beachblanketfestival.com: 127.0.0.1
    beachblanketfestival.com: 127.0.0.1
    hardwellmx-com.discodonniepresents.com: 127.0.0.1
    dayafter.com: 127.0.0.1
    somethingwicked.com: 127.0.0.1
    isladelsolfest.com: 127.0.0.1
    cominghomemusicfestival.com: 127.0.0.1
    monsterblockparty.com: 127.0.0.1
    freaksbeatstreats.com: 127.0.0.1
    ccf.discodonniepresents.com: 127.0.0.1
    2015.umesouthpadre.com: 127.0.0.1

  environment:
    NODE_ENV: ${CIRCLE_BRANCH}
    PHP_ENV: ${CIRCLE_BRANCH}
    WP_ENV: ${CIRCLE_BRANCH}
    # WP_HOME: http://www.discodonniepresents.com
    # WP_SITEURL: http://www.discodonniepresents.com
    # WP_CORE_DIR: ~/{CIRCLE_PROJECT_REPONAME}
    # WP_DB_NAME: edm_${CIRCLE_BRANCH}
    # WP_DB_HOST: localhost
    # WP_DB_USER: circle
    # WP_DB_PASSWORD: circle
    # CURRENT_BRANCH: ${CIRCLE_BRANCH}
    WP_DEBUG: true
    WP_DEBUG_DISPLAY: 0

dependencies:

  cache_directories:
    - "~/docker"
    - "/var/lib/docker"

  pre:
    # - sudo  apt-get install -y s3cmd
    - curl  -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar && chmod +x wp-cli.phar && sudo mv wp-cli.phar /usr/local/bin/wp
    - mkdir -p /home/ubuntu/storage
    - mkdir -p /home/ubuntu/docker
    - sudo rm -rf /var/www && sudo ln -fs /home/ubuntu/www.discodonniepresents.com /var/www
    - docker login --email="${DOCKER_HUB_EMAIL}" --username="${DOCKER_HUB_USERNAME}" --password="${DOCKER_HUB_PASSWORD}"
    - NODE_ENV=develop npm install
    # - mysql -e "CREATE DATABASE edm_develop;";
    # - mysql -e "CREATE DATABASE edm_staging;";
    # - mysql -e "CREATE DATABASE edm_production;";
    # - mysql -e "grant usage on *.* to circle@localhost identified by 'circle';";
    # - mysql -e "grant all privileges on edm_develop.* to circle@localhost;";
    # - mysql -e "grant all privileges on edm_staging.* to circle@localhost;";
    # - mysql -e "grant all privileges on edm_corporate.* to circle@localhost;";
    # - git config --global push.default simple
    # - git config --global user.email ${GITHUB_EMAIL}
    # - git config --global user.name ${GITHUB_USERNAME}

  override:
    # - if [[ -e ~/docker/www.discodonniepresents.com.tar ]]; then docker load -i ~/docker/www.discodonniepresents.com.tar; fi
    # - if [[ -e ~/docker/hipstack-hipstack.tar ]];           then docker load -i ~/docker/hipstack-hipstack.tar; fi
    # - if [[ -e ~/docker/wpcloud-site.tar ]];                then docker load -i ~/docker/wpcloud-site.tar; fi
    - docker pull hipstack/hipstack:latest  # ~ 2:15
    - docker pull wpcloud/site:latest       # ~ 1:24
    # - docker save hipstack/hipstack   > ~/docker/hipstack-hipstack.tar        # ~ 1.21
    # - docker save wpcloud/site        > ~/docker/wpcloud-site.tar             # ~ 1.05
    # - sudo service apache2 start

test:
  pre:
    - sudo make image

  override:
    - mocha --timeout 60000 --reporter list --ui exports --require should wp-content/static/tests/unit

deployment:

  staging:
    branch: develop
    commands:
      - make release
      # - docker save discodonniepresents/www.discodonniepresents.com > ~/docker/www.discodonniepresents.com.tar

  production:
    branch: production
    commands:
      - make release
      # - docker save discodonniepresents/www.discodonniepresents.com > ~/docker/www.discodonniepresents.com.tar
      # - wp cloud media push
      # - wp cloud release --group=edge --instance=2
      # - wp cloud release --group=edge --instance=2
